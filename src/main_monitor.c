/*
 * ==============================================================================
 * íŒŒì¼ëª…: main_monitor.c
 * ì—­í• : [P4] ì‚¬ìš©ì ëª¨ë‹ˆí„°ë§ ë° ì„¤ì • í”„ë¡œì„¸ìŠ¤
 *
 * ê¸°ìˆ  ìš”ì†Œ:
 *   - Shared Memory: ì„ê³„ê°’ ì„¤ì • ì½ê¸°/ì“°ê¸°, ì œì–´ ìƒíƒœ ì½ê¸°
 *   - Semaphore: Race Condition ë°©ì§€ë¥¼ ìœ„í•œ ë™ê¸°í™”
 *   - select(): ë…¼ë¸”ë¡œí‚¹ ì…ë ¥ìœ¼ë¡œ ì¢…ë£Œ ì‹ í˜¸ ê°ì§€
 *   - CLI ë©”ë‰´ ì¸í„°í˜ì´ìŠ¤
 *
 * ì‘ì„±ì: Virtual SmartFarm Team
 * ì‘ì„±ì¼: 2025-12-02
 * ==============================================================================
 */

#include "../include/common.h"
#include <sys/select.h>
#include <sys/utsname.h>

static int shm_id = -1;
static int sem_id = -1;
static SharedData *shared_data = NULL;

/* ============================================================================
 * í•¨ìˆ˜: display_system_info
 * ì„¤ëª…: ì‹œìŠ¤í…œ ë° í”„ë¡œì„¸ìŠ¤ ì •ë³´ ì¶œë ¥ (uname, getpid ì‚¬ìš©)
 * ============================================================================ */
void display_system_info() {
    struct utsname sys_info;
    
    printf("\n");
    printf("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n");
    printf("â”‚          ğŸ–¥ï¸  ì‹œìŠ¤í…œ ì •ë³´               â”‚\n");
    printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n");
    
    if (uname(&sys_info) == 0) {
        printf("â”‚  OS ì´ë¦„:     %-24s â”‚\n", sys_info.sysname);
        printf("â”‚  OS ë²„ì „:     %-24s â”‚\n", sys_info.release);
        printf("â”‚  í˜¸ìŠ¤íŠ¸ëª…:    %-24s â”‚\n", sys_info.nodename);
        printf("â”‚  ì•„í‚¤í…ì²˜:    %-24s â”‚\n", sys_info.machine);
    }
    
    printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n");
    printf("â”‚          ğŸ“Š í”„ë¡œì„¸ìŠ¤ ì •ë³´              â”‚\n");
    printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n");
    printf("â”‚  ëª¨ë‹ˆí„° PID:  %-24d â”‚\n", getpid());
    printf("â”‚  ë¶€ëª¨ PID:    %-24d â”‚\n", getppid());
    printf("â”‚  ì‚¬ìš©ì ID:   %-24d â”‚\n", getuid());
    printf("â”‚  ê·¸ë£¹ ID:     %-24d â”‚\n", getgid());
    printf("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
}

/* ============================================================================
 * í•¨ìˆ˜: cleanup_and_exit
 * ì„¤ëª…: ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ - í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì‹œ ìì› ì •ë¦¬
 * ============================================================================ */
void cleanup_and_exit(int signo) {
    (void)signo;  // unused parameter ê²½ê³  ë°©ì§€
    printf("\n[MONITOR] ì¢…ë£Œ ì¤‘...\n");
    if (shared_data != NULL) {
        shmdt(shared_data);
    }
    exit(0);
}

/* ============================================================================
 * í•¨ìˆ˜: check_system_running
 * ì„¤ëª…: ì„œë²„ ì¢…ë£Œ ì‹ í˜¸ í™•ì¸
 * ë°˜í™˜: 1=ì‹¤í–‰ì¤‘, 0=ì¢…ë£Œë¨
 * ============================================================================ */
int check_system_running() {
    sem_lock(sem_id);
    int running = shared_data->system_running;
    sem_unlock(sem_id);
    return running;
}

/* ============================================================================
 * í•¨ìˆ˜: display_menu
 * ì„¤ëª…: CLI ë©”ë‰´ ì¶œë ¥
 * ============================================================================ */
void display_menu() {
    printf("\n");
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘   ğŸ›ï¸  SMART FARM CONFIGURATION MENU ğŸ›ï¸          â•‘\n");
    printf("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\n");
    printf("â•‘  1. ì˜¨ë„ ì„ê³„ê°’ ì„¤ì •                           â•‘\n");
    printf("â•‘  2. ìŠµë„ ì„ê³„ê°’ ì„¤ì •                           â•‘\n");
    printf("â•‘  3. í˜„ì¬ ì„¤ì • ë° ìƒíƒœ í™•ì¸                     â•‘\n");
    printf("â•‘  4. ì‹œìŠ¤í…œ ì •ë³´ í™•ì¸                           â•‘\n");
    printf("â•‘  5. ì¢…ë£Œ                                       â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
    printf("ì„ íƒ: ");
    fflush(stdout);
}

/* ============================================================================
 * í•¨ìˆ˜: display_status
 * ì„¤ëª…: í˜„ì¬ ì„¤ì •ê°’ê³¼ ì œì–´ ìƒíƒœ ì¶œë ¥
 * ============================================================================ */
void display_status() {
    sem_lock(sem_id);
    printf("\n");
    printf("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n");
    printf("â”‚          ğŸ“Š í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ            â”‚\n");
    printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n");
    printf("â”‚  [í˜„ì¬ í™˜ê²½]                            â”‚\n");
    printf("â”‚    ğŸŒ¡ï¸  ì˜¨ë„: %6.1fÂ°C                   â”‚\n", shared_data->current_temp);
    printf("â”‚    ğŸ’§ ìŠµë„: %6.1f%%                    â”‚\n", shared_data->current_humidity);
    printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n");
    printf("â”‚  [ì„ê³„ê°’ ì„¤ì •]                          â”‚\n");
    printf("â”‚    ì˜¨ë„ ì„ê³„ê°’: %3dÂ°C                   â”‚\n", shared_data->temp_threshold);
    printf("â”‚    ìŠµë„ ì„ê³„ê°’: %3d%%                    â”‚\n", shared_data->humidity_threshold);
    printf("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n");
    printf("â”‚  [í˜„ì¬ ì œì–´ ìƒíƒœ]                       â”‚\n");
    printf("â”‚    ğŸ”¥ íˆí„°: %s                         â”‚\n", shared_data->heater_on ? "ON " : "OFF");
    printf("â”‚    ğŸ’¨ íŒ¬:   %s                         â”‚\n", shared_data->fan_on ? "ON " : "OFF");
    printf("â”‚    ğŸ’¡ LED:  %s                         â”‚\n", shared_data->led_on ? "ON " : "OFF");
    printf("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n");
    sem_unlock(sem_id);
}

/* ============================================================================
 * í•¨ìˆ˜: input_available
 * ì„¤ëª…: select()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì…ë ¥ì´ ìˆëŠ”ì§€ í™•ì¸ (íƒ€ì„ì•„ì›ƒ: 1ì´ˆ)
 * ë°˜í™˜: 1=ì…ë ¥ ìˆìŒ, 0=ì…ë ¥ ì—†ìŒ
 * ============================================================================ */
int input_available() {
    fd_set fds;
    struct timeval tv;
    
    FD_ZERO(&fds);
    FD_SET(STDIN_FILENO, &fds);
    
    tv.tv_sec = 1;   // 1ì´ˆ íƒ€ì„ì•„ì›ƒ
    tv.tv_usec = 0;
    
    return select(STDIN_FILENO + 1, &fds, NULL, NULL, &tv) > 0;
}

/* ============================================================================
 * ë©”ì¸ í•¨ìˆ˜
 * ============================================================================ */
int main() {
    printf("==================================================\n");
    printf("  ê°€ìƒ ìŠ¤ë§ˆíŠ¸íŒœ ëª¨ë‹ˆí„° í”„ë¡œì„¸ìŠ¤ [P4] ì‹œì‘\n");
    printf("==================================================\n");
    printf("  PID: %d, ë¶€ëª¨ PID: %d\n\n", getpid(), getppid());

    // ì‹œê·¸ë„ í•¸ë“¤ëŸ¬ ë“±ë¡
    signal(SIGINT, cleanup_and_exit);
    signal(SIGTERM, cleanup_and_exit);

    // ========================================================================
    // IPC ìì› ì—°ê²°
    // ========================================================================

    // ê³µìœ  ë©”ëª¨ë¦¬ ì—°ê²°
    shm_id = shmget(SHM_KEY, sizeof(SharedData), 0666);
    if (shm_id == -1) {
        perror("[MONITOR] ê³µìœ  ë©”ëª¨ë¦¬ ì—°ê²° ì‹¤íŒ¨ (ì„œë²„ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”)");
        exit(1);
    }
    shared_data = (SharedData *)shmat(shm_id, NULL, 0);
    if (shared_data == (void *)-1) {
        perror("[MONITOR] ê³µìœ  ë©”ëª¨ë¦¬ attach ì‹¤íŒ¨");
        exit(1);
    }
    printf("[MONITOR] ê³µìœ  ë©”ëª¨ë¦¬ ì—°ê²° ì„±ê³µ (ID: %d)\n", shm_id);

    // ì„¸ë§ˆí¬ì–´ ì—°ê²°
    sem_id = semget(SEM_KEY, 1, 0666);
    if (sem_id == -1) {
        perror("[MONITOR] ì„¸ë§ˆí¬ì–´ ì—°ê²° ì‹¤íŒ¨ (ì„œë²„ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”)");
        exit(1);
    }
    printf("[MONITOR] ì„¸ë§ˆí¬ì–´ ì—°ê²° ì„±ê³µ (ID: %d)\n", sem_id);

    // ========================================================================
    // ë©”ì¸ ë£¨í”„: CLI ë©”ë‰´ (select ê¸°ë°˜ ë…¼ë¸”ë¡œí‚¹)
    // ========================================================================
    int choice;
    int menu_displayed = 0;
    
    while (1) {
        // ì‹œìŠ¤í…œ ì¢…ë£Œ í™•ì¸
        if (!check_system_running()) {
            printf("\n[MONITOR] ì„œë²„ ì¢…ë£Œ ì‹ í˜¸ ìˆ˜ì‹ . í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ.\n");
            break;
        }

        // ë©”ë‰´ í‘œì‹œ (í•œ ë²ˆë§Œ)
        if (!menu_displayed) {
            display_menu();
            menu_displayed = 1;
        }

        // ì…ë ¥ ëŒ€ê¸° (1ì´ˆ íƒ€ì„ì•„ì›ƒ) - íƒ€ì„ì•„ì›ƒ í›„ ì¢…ë£Œ ì‹ í˜¸ ë‹¤ì‹œ ì²´í¬
        if (!input_available()) {
            continue;
        }

        // ì…ë ¥ ì²˜ë¦¬
        if (scanf("%d", &choice) != 1) {
            while (getchar() != '\n');
            printf("âŒ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.\n");
            menu_displayed = 0;
            continue;
        }

        menu_displayed = 0;  // ë‹¤ìŒ ë£¨í”„ì—ì„œ ë©”ë‰´ ë‹¤ì‹œ í‘œì‹œ

        switch (choice) {
            case 1: {
                int new_temp;
                printf("ìƒˆë¡œìš´ ì˜¨ë„ ì„ê³„ê°’ (20~40Â°C): ");
                if (scanf("%d", &new_temp) == 1 && new_temp >= 20 && new_temp <= 40) {
                    sem_lock(sem_id);
                    shared_data->temp_threshold = new_temp;
                    sem_unlock(sem_id);
                    printf("âœ… ì˜¨ë„ ì„ê³„ê°’ì´ %dÂ°Cë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n", new_temp);
                } else {
                    printf("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì…ë‹ˆë‹¤. (20~40 ë²”ìœ„)\n");
                    while (getchar() != '\n');
                }
                break;
            }
            case 2: {
                int new_hum;
                printf("ìƒˆë¡œìš´ ìŠµë„ ì„ê³„ê°’ (30~90%%): ");
                if (scanf("%d", &new_hum) == 1 && new_hum >= 30 && new_hum <= 90) {
                    sem_lock(sem_id);
                    shared_data->humidity_threshold = new_hum;
                    sem_unlock(sem_id);
                    printf("âœ… ìŠµë„ ì„ê³„ê°’ì´ %d%%ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n", new_hum);
                } else {
                    printf("âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ê°’ì…ë‹ˆë‹¤. (30~90 ë²”ìœ„)\n");
                    while (getchar() != '\n');
                }
                break;
            }
            case 3:
                display_status();
                break;
            case 4:
                display_system_info();
                break;
            case 5:
                cleanup_and_exit(0);
                break;
            default:
                printf("âŒ ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤. (1~5)\n");
        }
    }

    cleanup_and_exit(0);
    return 0;
}
